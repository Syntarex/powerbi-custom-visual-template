/*
[
    {
        "DATE": "2022-07-16T14:26:37",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test123456",
        "TO": null,
        "OPERATION": "DELETE"
    },
    {
        "DATE": "2023-01-15T14:14:21.262696",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "DE1164778",
        "TO": "Test123456",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T14:14:17.842343",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": null,
        "TO": "DE1164778",
        "OPERATION": "INSERT"
    },
    {
        "DATE": "2023-01-15T13:46:36",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test123456",
        "TO": null,
        "OPERATION": "DELETE"
    },
    {
        "DATE": "2023-01-15T13:46:33.969622",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "DE1164778",
        "TO": "Test123456",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T13:45:55.515245",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": null,
        "TO": "DE1164778",
        "OPERATION": "INSERT"
    },
    {
        "DATE": "2023-01-15T13:35:45.496657",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": null,
        "TO": "DE1164778",
        "OPERATION": "INSERT"
    },
    {
        "DATE": "2023-01-15T13:35:14.375053",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test123456",
        "TO": "Test123456",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T13:35:11.335290",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "DE1164778",
        "TO": "Test123456",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T13:08:07.821233",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": null,
        "TO": "DE1164778",
        "OPERATION": "INSERT"
    },
    {
        "DATE": "2023-01-15T12:52:20",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test123456",
        "TO": null,
        "OPERATION": "DELETE"
    },
    {
        "DATE": "2023-01-15T12:52:17.817894",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test123",
        "TO": "Test123456",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T12:52:14.835573",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "Test",
        "TO": "Test123",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T12:52:11.340581",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": "DE1164778",
        "TO": "Test",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-15T12:52:09.148329",
        "ACTIVITY": "Versorgungsnetzwerk",
        "EDITOR": "Service User",
        "COLUMN": "Versorger",
        "FROM": null,
        "TO": "DE1164778",
        "OPERATION": "INSERT"
    },
    {
        "DATE": "2023-01-13T20:38:05",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Therapie: NUB Tremelimumab gestellt",
        "FROM": "Ja",
        "TO": "Nein",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T20:15:24",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Nein",
        "TO": "Ja",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T20:06:16",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Ja",
        "TO": "Nein",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T20:05:25",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Nein",
        "TO": "Ja",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T17:30:54",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Ja",
        "TO": "Nein",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T17:30:51",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Nein",
        "TO": "Ja",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T17:30:49",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Ja",
        "TO": "Nein",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T17:30:46",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Nein",
        "TO": "Ja",
        "OPERATION": "UPDATE"
    },
    {
        "DATE": "2023-01-13T17:25:55",
        "ACTIVITY": "Account Plan",
        "EDITOR": "Service User",
        "COLUMN": "Praxis",
        "FROM": "Ja",
        "TO": "Nein",
        "OPERATION": "UPDATE"
    }
]
*/

import { Box, SxProps } from "@mui/material";
import { DataGridPro, GridColDef } from "@mui/x-data-grid-pro";
import dayjs from "dayjs";
import { toLower } from "lodash";
import React, { useMemo } from "react";
import { useRecoilValue } from "recoil";
import { hcasAtom } from "../../data/hca.data";
import { hcaLocals } from "../../loc/account.loc";
import { ChangeData, Hca } from "../../model/hca.model";

interface RowData {
    id: string;
    date: Date;
    hca_name: string;
    details: ChangeData[];
}

const columns: GridColDef[] = [
    {
        field: "date",
        headerName: "Bearbeitet am",
        flex: 2,
        minWidth: 120,
        valueGetter: (params) => dayjs(params.value).unix(),
        valueFormatter: (params) => dayjs(params.value * 1000).format("DD.MM.YYYY"),
    },
    { field: "hca_name", headerName: "Account Name", flex: 4 },
    {
        field: "details",
        headerName: "Details",
        flex: 6,
        sortable: false,
        valueFormatter: (params) => {
            const data = (params.value as ChangeData[]) ?? [];

            let details = "";

            for (const each of data) {
                if (details) {
                    details += "\n\n";
                }

                switch (toLower(each.OPERATION).trim()) {
                    case "delete":
                        details += `Wurde von ${each.EDITOR} gelöscht.`;
                        break;
                    case "insert":
                        details += `Wurde von ${each.EDITOR} hinzugefügt.`;
                        break;
                    case "update":
                        details += `${each.EDITOR} hat ${hcaLocals[each.COLUMN] ?? each.COLUMN} von ${
                            each.FROM ?? "<nichts>"
                        } zu ${each.TO ?? "<nichts>"} geändert.`;
                        break;
                }
            }

            return details;
        },
    },
];

interface HcaChangelogProps {
    sx?: SxProps;
    height?: number;
    hca?: Hca /** If present the changelog will only show changes of this hca. Otherwise the changelog will show changes of all hcas.  */;
}

export const HcaChangelog = (props: HcaChangelogProps) => {
    const { sx, height = 600, hca } = props;

    const allHcas = useRecoilValue(hcasAtom);

    const data = useMemo<RowData[]>(() => {
        const rowData: RowData[] = [];

        // If there is a hca passed by props, we want to show changes of this hca only
        const hcas = hca ? [hca] : allHcas;

        const hcasWithChanges = hcas.filter((each) => each.CHANGES && each.CHANGES.length > 0);

        for (let i = 0; i < hcasWithChanges.length; i++) {
            const each = hcasWithChanges[i];

            const rowDataOfHca: RowData[] = (each.CHANGES ?? []).map((change, index) => ({
                id: `${i}-${index}`,
                date: new Date(change.DATE),
                hca_name: each.NAME,
                details: change.DATA ?? [],
            }));

            rowData.push(...rowDataOfHca);
        }

        return rowData;
    }, [allHcas, hca]);

    return (
        <Box sx={{ height, ...sx }}>
            <DataGridPro
                sx={{
                    "&.MuiDataGrid-root--densityCompact .MuiDataGrid-cell": { py: "8px" },
                    "&.MuiDataGrid-root--densityStandard .MuiDataGrid-cell": { py: "15px" },
                    "&.MuiDataGrid-root--densityComfortable .MuiDataGrid-cell": { py: "22px" },
                }}
                rows={data}
                columns={columns}
                getRowHeight={() => "auto"}
                initialState={{
                    sorting: {
                        sortModel: [{ field: "date", sort: "desc" }],
                    },
                    columns: {
                        columnVisibilityModel: {
                            hca_name: !hca,
                        },
                    },
                }}
            />
        </Box>
    );
};
